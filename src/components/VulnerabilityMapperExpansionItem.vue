<template>
	<div class="q-pa-md">
		<q-expansion-item
			:label="t('VulnerabilityMapperComponent_Title')"
			default-opened
		>
			<q-card>
				<q-card-section>
					<div class="row fit q-col-gutter-md">
						<div class="col-12 col-md-6">
							<!-- Example Table -->
							<table style="width: 100%">
								<tr
									v-for="(
										row, rowIndex
									) in props.vulnerabilityCardExample"
									:key="`exmaple-row-${rowIndex}`"
								>
									<td
										v-for="(col, colIndex) in row"
										:colspan="
											colIndex === row.length - 1
												? maxColCount - colIndex
												: 1
										"
										:key="`exmaple-col-${colIndex}`"
									>
										<q-select
											dense
											:model-value="col"
											readonly
											disable
										/>
									</td>
								</tr>
							</table>
						</div>
						<!-- Mapper Table -->
						<div class="col-12 col-md-6">
							<!-- Example Table -->
							<table style="width: 100%">
								<tr
									v-for="(
										row, rowIndex
									) in props.vulnerabilityCardExample"
									:key="`exmaple-row-${rowIndex}`"
								>
									<td
										v-for="(col, colIndex) in row"
										:colspan="
											colIndex === row.length - 1
												? maxColCount - colIndex
												: 1
										"
										:key="`exmaple-col-${colIndex}`"
									>
										<q-select
											dense
											:model-value="
												t(
													vulnerabilityCardMapper?.[
														rowIndex
													]?.[colIndex] || ''
												)
											"
											:options="
												[
													...Object.keys(
														VulnerabilityFields
													),
													...Object.keys(
														VulnerabilityExtraFields
													),
												].map((value) => ({
													label: t(value),
													value: value,
												}))
											"
											emit-value
											@update:model-value="
												(value: VulnerabilityDetailedFields) => {
													const fieldOldCoords = fieldFinder(value);
													if( fieldOldCoords !== undefined) delete vulnerabilityCardMapper[fieldOldCoords.row][fieldOldCoords.col];
													if (
														vulnerabilityCardMapper[
															rowIndex
														] === undefined
													)
														vulnerabilityCardMapper[
															rowIndex
														] = {};
													vulnerabilityCardMapper[
														rowIndex
													][colIndex] = value;
												}
											"
										/>
									</td>
								</tr>
							</table>
						</div>
					</div>
				</q-card-section>
			</q-card>
		</q-expansion-item>
	</div>
</template>

<script setup lang="ts">
import { useI18n } from 'vue-i18n';
import {
	VulnerabilityCardMapper,
	VulnerabilityDetailedFields,
	VulnerabilityExtraFields,
	VulnerabilityFields,
} from './models';
import { computed } from 'vue';

const props = defineProps<{
	vulnerabilityCardExample: string[][];
}>();

const vulnerabilityCardMapper = defineModel<VulnerabilityCardMapper>({
	required: true,
});

const maxColCount = computed(() =>
	Math.max(...props.vulnerabilityCardExample.map((list) => list.length))
);

const { t } = useI18n();

function fieldFinder(
	field: VulnerabilityDetailedFields
): { row: number; col: number } | undefined {
	let fieldPosition = {
		row: -1,
		col: -1,
	};
	let found = false;
	for (
		let rowIndex = 0;
		rowIndex < props.vulnerabilityCardExample.length;
		rowIndex++
	) {
		for (
			let colIndex = 0;
			colIndex < props.vulnerabilityCardExample[rowIndex].length;
			colIndex++
		) {
			if (vulnerabilityCardMapper.value[rowIndex]?.[colIndex] === field) {
				fieldPosition.row = rowIndex;
				fieldPosition.col = colIndex;
				found = true;
				break;
			}
		}
		if (found) break;
	}
	return found ? fieldPosition : undefined;
}
</script>
<style scoped>
table,
th,
td {
	border: 1px solid black;
}
</style>
